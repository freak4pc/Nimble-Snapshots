references:
    defaults: &defaults
        macos:
            xcode: "10.0.0"
        working_directory: /Users/distiller/project
        environment:
            BUNDLE_PATH: vendor/bundle
            
    restore_bundle_cache: &restore_bundle_cache
        restore_cache:
            keys:
                - v1-gems-{{ checksum "Gemfile.lock" }}
                # Fall back to using the latest cache if no exact match is found.
                - v1-gems-

    save_bundle_cache: &save_bundle_cache
        save_cache:
            keys: v1-gems-{{ checksum "Gemfile.lock" }}
            paths:
                - vendor/bundle

    bunde_install: &bunde_install
        run:
          name: "Install bundle"
          command: bundle check || bundle install

version: 2
jobs:
  test:
    <<: *defaults
    steps:
      - checkout
      - *restore_bundle_cache
      - *save_bundle_cache
      - run:
          name: "Create output dir"
          command: mkdir output
      - run:
          name: "Run tests in Swift 4.0"
          command: rake test
          environment:
             SWIFT_VERSION: 4.0
      - run: 
          name: second curtain
          command: bundle exec second_curtain output/xcodebuild_swift4.0.log
          when: on_fail
      - run:
          name: "Run tests in Swift 4.2"
          command: rake test
          environment:
             SWIFT_VERSION: 4.2
      - run: 
          name: second curtain
          command: bundle exec second_curtain output/xcodebuild_swift4.2.log
          when: on_fail

      - store_artifacts:
          path: output/
      - store_test_results:
          path: output/
    
  carthage-integration-test:
    <<: *defaults
    steps:
      - checkout
      - *restore_bundle_cache
      - *save_bundle_cache 
      - run:
          name: "Run Carthage integration test"
          command: rake carthage
   
  danger:
    <<: *defaults
    steps:
      - checkout
      - *restore_bundle_cache
      - *save_bundle_cache 
      - run:
          name: "Run Danger"
          command: bundle exec danger
  
workflows:
  version: 2
  build-test:
    jobs:
      - build-and-test
      - carthage-integration-test
      - danger